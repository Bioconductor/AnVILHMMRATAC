---
title: "Quality Control of AnVILHMMRATAC Data"
author:
- name: Kayla Interdonato
  affiliation: Roswell Park Comprehensive Cancer Center, Buffalo, NY
date: "`r Sys.Date()`"
output:
    BiocStyle::html_document:
        toc: true
        toc_float: true
vignette: >
  %\VignetteIndexEntry{A_QC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The goal of the `AnVILHMMRATAC` package is to provide users all the tools to
perform a `HMMRATAC` analysis utilizing AnVIL. This package contains all the
files (except for raw reference genome and chromosome information) needed to
complete the analysis.

This vignette will demonstrate to the user how to perform a quality check of
the alignment using the `r Biocpkg("ATACseqQC")` package. The bam files for each
file will be obtained from the Google bucket of this project.

# Installation

The following code will install the latest version of the `AnVILHMMRATAC`
package from Bioconductor.

```{r install, eval = FALSE}
if(!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("AnVILHMMRATAC")
```

Then to load `AnVILHMMRATAC`:

```{r load, message = FALSE}
library(AnVILHMMRATAC)
```

We will also need the `AnVIL` package for certain functionality so we will
install and load it now.

```{r anvil}
pkgs = c("Bioconductor/AnVIL", "Rsamtools", "ATACseqQC") 
BiocManager::install(pkgs)

suppressPackageStartupMessages({
    library(AnVIL)
    library(Rsamtools)
    library(ATACseqQC)
})
```

# Locate the files

We will be performing QC on each of the bam files produced from the 
AnVILHMMRATAC workflow. In order to run this QC we must first locate the bam 
files. We have saved the sorted bam files from the workflow, so sorting is not
needed. If your bam files have not been sorted, we suggest doing this first.

As part of the workflow, we saved the default outputs. This means that the paths
to the outputs were saved in the corresponding entry in the 'participant_set'
table. We will obtain the paths from here.

```{r paths}
avworkspace("bioconductor-rpci-anvil/HMMRATAC")
sorted_bams <- unlist(avtable("participant_set") %>%
    tail(1) %>%
    pull("sorted_bam.items")
    )

## I want to localize but the function looks for a directory to localize, 
## not individual files
lapply(sorted_bams, function(x) AnVIL::localize(x, getwd(), dry = FALSE))

## will copy for now, until I can figure out localize
AnVIL::gsutil_cp(sorted_bams, getwd())
```

# Perform QC

Next we will use the `ATACseqQC` package to assess the quality of the
alignment.

```{r qc}
fls <- list.files(".", pattern = "*.bam$")
lapply(fls, function(x) {
    estimateLibComplexity(readsDupFreq(x))
    fragSize[x] <- fragSizeDist(x, "Frag Sizes")
}
fragSize
```

We can also perform footprint identification with `ATACseqQC`.

```{r footprint}
library(BSgenome.Hsapiens.UCSC.hg19)
library(MotifDb)
CTCF <- query(MotifDb, c("CTCF"))
CTCF <- as.list(CTCF)
seqlev <- "chr1"

lapply(fls, function(x) {
    sigs[x] <- factorFootprints(x,
        pfm = CTCF[[1]],
        genome = Hsapiens,
        min.score = "90%",
        seqlev = seqlev,
        upstream = 100,
        downstream = 100)
})

featureAlignedHeatmap(sigs$signal,
    feature.gr = reCenterPeaks(sigs$bindingSites,
        width = 200+width(sigs$bindingSites[1])),
    annoMcols = "score",
    sortBy = "score",
    n.tile = ncol(sigs$signal[[1]]))
```                                                 

# Session Information

```{r}
sessionInfo()
```
